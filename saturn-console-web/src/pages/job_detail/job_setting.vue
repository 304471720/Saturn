<template>
    <div class="page-content" v-loading="loading" element-loading-text="请稍等···">
        <el-form :model="jobSettingInfo" :rules="rules" ref="jobSettingInfo" label-width="140px">
            <el-button type="primary" @click.stop="updateInfo" style="margin-bottom: 10px;" :disabled="jobSettingInfo.enabled"><i class="fa fa-undo"></i>更新</el-button>
            <el-collapse v-model="activeNames">
                <el-collapse-item name="1">
                    <template slot="title">
                        基本配置
                    </template>
                    <div class="job-setting-content">
                        <el-row v-if="jobSettingInfo.jobType === 'JAVA_JOB'">
                            <el-col :span="22">
                                <el-form-item prop="jobClass" label="作业实现类" required>
                                    <el-input v-model="jobSettingInfo.jobClass"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="22">
                                <el-form-item prop="cron" label="Cron">
                                    <el-tooltip popper-class="form-tooltip" content="作业启动时间的cron表达式。如每10秒运行:*/10****?,每5分钟运行:0*/5***?" placement="bottom">
                                        <el-input v-model="jobSettingInfo.cron">
                                            <el-button slot="append" @click="checkAndForecastCron" style="margin-top: -15px">预测</el-button>
                                        </el-input>
                                    </el-tooltip>
                                </el-form-item>
                                <el-form-item class="form-annotation">
                                    <span>1. 每10秒运行: */10 * * * * ?</span><br/>
                                    <span>2. 每5分钟运行: 0*/5 * * * ?</span>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row :gutter="10">
                            <el-col :span="11">
                                <el-form-item prop="shardingTotalCount" label="作业分片数" v-if="!jobSettingInfo.localMode">
                                    <el-input-number v-model="jobSettingInfo.shardingTotalCount" controls-position="right" :min="1" style="width: 100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item prop="shardingTotalCount" label="作业分片数" v-if="jobSettingInfo.localMode">
                                    <el-input value="N/A" disabled style="width: 100%;"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="5">
                                <el-form-item prop="localMode" label="本地模式" label-width="80px">
                                    <el-switch v-model="jobSettingInfo.localMode"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="6" v-if="!jobSettingInfo.localMode">
                                <el-form-item prop="onlyUsePreferList" label="只使用优先executor">
                                    <el-switch v-model="jobSettingInfo.onlyUsePreferList"></el-switch>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="22">
                                <el-form-item prop="shardingItemParameters" label="分片序列号/参数对照表">
                                    <el-tooltip popper-class="form-tooltip" content="分片序列号和参数用等号分隔，多个键值对用逗号分隔，类似map。分片序列号从0开始，不可大于或等于作业分片总数。如：0=a,1=b,2=c; 英文双引号请使用!!代替，英文等号请使用@@代替，英文逗号请使用##代替,。特别的，对于本地模式的作业，只需要输入如：*=a，就可以了。" placement="bottom">
                                        <el-input type="textarea" v-model="jobSettingInfo.shardingItemParameters"></el-input>
                                    </el-tooltip>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="22">
                                <el-form-item prop="jobParameter" label="自定义参数">
                                    <el-tooltip popper-class="form-tooltip" content="配置格式: 多个配置使用逗号分隔(key1=value1, key2=value2)。在分片序列号/参数对照表中可作为alias形式引用，格式为{key1}" placement="bottom">
                                        <el-input type="textarea" v-model="jobSettingInfo.jobParameter"></el-input>
                                    </el-tooltip>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="22">
                                <el-form-item prop="preferListList" label="优先executor">
                                    <el-select size="small" filterable multiple v-model="jobSettingInfo.preferListList" style="width: 100%;">
                                        <el-option v-for="item in jobSettingInfo.preferListProvided" :label="item.executorName" :value="item.executorName" :key="item.executorName">
                                            <span style="float: left">{{ item.executorName }}</span>
                                            <span style="float: left">({{ statusOnline[item.type] }})</span>
                                        </el-option>
                                    </el-select>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="22">
                                <el-form-item prop="description" label="作业描述信息">
                                    <el-input type="textarea" v-model="jobSettingInfo.description"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </div>
                </el-collapse-item>
                <el-collapse-item name="2">
                    <template slot="title">
                        高级配置
                    </template>
                    <div class="job-setting-content">
                        <el-row>
                            <el-col :span="11">
                                <el-form-item prop="timeout4AlarmSeconds" label="超时告警(秒)">
                                    <el-input v-model="jobSettingInfo.timeout4AlarmSeconds"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="11">
                                <el-form-item prop="timeoutSeconds" label="超时强杀(秒)">
                                    <el-input v-model="jobSettingInfo.timeoutSeconds"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="22">
                                <el-form-item prop="groups" label="所属分组">
                                    <el-input v-model="jobSettingInfo.groups"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="11">
                                <el-form-item prop="loadLevel" label="作业负荷">
                                    <el-input v-model="jobSettingInfo.loadLevel"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="11">
                                <el-form-item prop="processCountIntervalSeconds" label="统计处理间隔(秒)">
                                    <el-input v-model="jobSettingInfo.processCountIntervalSeconds"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="11">
                                <el-form-item prop="timeZone" label="时区">
                                    <el-select size="small" filterable v-model="jobSettingInfo.timeZone">
                                        <el-option v-for="item in jobSettingInfo.timeZonesProvided" :label="item" :value="item" :key="item"></el-option>
                                    </el-select>
                                </el-form-item>
                            </el-col>
                            <el-col :span="6">
                                <el-form-item prop="showNormalLog" label="控制台输出日志">
                                    <el-switch v-model="jobSettingInfo.showNormalLog"></el-switch>
                                </el-form-item>
                            </el-col>
                            <el-col :span="6">
                                <el-form-item prop="enabledReport" label="上报运行状态" label-width="100px">
                                    <el-switch v-model="jobSettingInfo.enabledReport"></el-switch>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="22">
                                <el-form-item prop="dependenciesList" label="依赖作业">
                                    <el-select size="small" filterable multiple v-model="jobSettingInfo.dependenciesList" style="width: 100%;">
                                        <el-option v-for="item in jobSettingInfo.dependenciesProvided" :label="item" :value="item" :key="item"> </el-option>
                                    </el-select>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="22">
                                <el-form-item prop="pausePeriodDateList" label="暂停日期段">
                                    <el-tooltip popper-class="form-tooltip" content="日期时间段，支持多个日期段，逗号隔开。例如03/12-03/15,11/23-12/25。当日期为空，时间段不为空，表示每天那些时间段都暂停" placement="bottom">
                                        <InputTags :dynamic-tags="jobSettingInfo.pausePeriodDateList" title="日期段"></InputTags>
                                    </el-tooltip>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="22">
                                <el-form-item prop="pausePeriodTimeList" label="暂停时间段">
                                    <el-tooltip popper-class="form-tooltip" content="日期时间段，支持多个时间段，逗号隔开。例如12:23-13:23,16:00-17:00。当日期为不空，时间段为空，表示那些日期段24小时都暂停" placement="bottom">
                                        <InputTags :dynamic-tags="jobSettingInfo.pausePeriodTimeList" title="时间段"></InputTags>
                                    </el-tooltip>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </div>
                </el-collapse-item>
            </el-collapse>
            <el-button type="primary" @click.stop="updateInfo" style="margin-top: 10px;" :disabled="jobSettingInfo.enabled"><i class="fa fa-undo"></i>更新</el-button>
        </el-form>
        <div v-if="isCronPredictVisible">
            <CronPredictDialog :cron-predict-params="cronPredictParams" @close-dialog="closeCronDialog"></CronPredictDialog>
        </div>
    </div>
</template>
<script>
export default {
  props: [],
  data() {
    return {
      loading: false,
      isCronPredictVisible: false,
      domainName: this.$route.params.domain,
      jobName: this.$route.params.jobName,
      activeNames: ['1'],
      cronPredictParams: {},
      rules: {
        jobClass: [{ required: true, message: '作业实现类不能为空', trigger: 'blur' }],
      },
      statusOnline: {
        ONLINE: '在线',
        OFFLINE: '离线',
      },
    };
  },
  methods: {
    checkAndForecastCron() {
      const cronData = {
        timeZone: this.jobSettingInfo.timeZone,
        cron: this.jobSettingInfo.cron,
      };
      this.cronPredictParams = JSON.parse(JSON.stringify(cronData));
      this.isCronPredictVisible = true;
    },
    closeCronDialog() {
      this.isCronPredictVisible = false;
    },
    updateInfo() {
      this.$refs.jobSettingInfo.validate((valid) => {
        if (valid) {
          if (this.validateLocalMode()) {
            if (this.jobSettingInfo.localMode) {
              this.jobSettingInfo.shardingTotalCount = 'N/A';
              this.jobSettingInfoRequest();
            }
          } else {
            this.$message.errorMessage('作业分片参数有误，对于本地模式的作业，只需要输入如：*=a 即可。');
          }
        }
      });
    },
    jobSettingInfoRequest() {
      this.$http.post(`/console/namespaces/${this.domainName}/jobs/${this.jobName}/config`, this.jobSettingInfo).then(() => {
        this.getJobSettingInfo();
        this.$message.successNotify('更新作业操作成功');
      })
      .catch(() => { this.$http.buildErrorHandler('更新作业请求失败！'); });
    },
    validateLocalMode() {
      let flag = true;
      if (this.jobSettingInfo.localMode) {
        if (!this.jobSettingInfo.shardingItemParameters.startsWith('*=')) {
          flag = false;
        }
      }
      return flag;
    },
    getJobSettingInfo() {
      const params = {
        domainName: this.domainName,
        jobName: this.jobName,
      };
      this.loading = true;
      this.$store.dispatch('setJobInfo', params).then((resp) => {
        console.log(resp);
      })
      .catch(() => this.$http.buildErrorHandler('获取作业信息请求失败！'))
      .finally(() => {
        this.loading = false;
      });
    },
  },
  computed: {
    jobSettingInfo() {
      return this.$store.state.global.jobInfo;
    },
  },
};
</script>
<style lang="sass">
.job-setting-content {
    padding: 10px 15% 0;
}
</style>
